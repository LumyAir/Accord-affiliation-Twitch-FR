!function(t){var e={};function __webpack_require__(s){if(e[s])return e[s].exports;var o=e[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,__webpack_require__),o.l=!0,o.exports}__webpack_require__.m=t,__webpack_require__.c=e,__webpack_require__.d=function(t,e,s){__webpack_require__.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},__webpack_require__.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},__webpack_require__.t=function(t,e){if(1&e&&(t=__webpack_require__(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(__webpack_require__.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)__webpack_require__.d(s,o,function(e){return t[e]}.bind(null,o));return s},__webpack_require__.n=function(t){var e=t&&t.__esModule?function getDefault(){return t.default}:function getModuleExports(){return t};return __webpack_require__.d(e,"a",e),e},__webpack_require__.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},__webpack_require__.p="//cdn.frankerfacez.com/static/addons/",__webpack_require__(__webpack_require__.s=82)}({82:function(t,e,s){"use strict";s.r(e);class Socket{constructor(t,e){this.parent=t,this.socket=!1,this._connected=!1,this._connecting=!1,this._connect_attempts=1,this._joined_channels={},this._connection_buffer=[],this._events=e}connect(){this.parent.site.getUser()&&(this._connected||this._connecting||(this._connecting=!0,this.parent.log.info("Socket: Connecting to socket server..."),this.socket=new WebSocket("wss://sockets.betterttv.net/ws"),this.socket.onopen=()=>{if(this.parent.log.info("Socket: Connected to socket server."),this._connected=!0,this._connect_attempts=1,this._connection_buffer.length>0){let t=this._connection_buffer.length;for(;t--;){const e=this._connection_buffer[t];this.joinChannel(e)}this._connection_buffer=[]}this.reconnecting&&(this.reconnecting=!1)},this.socket.onerror=()=>{this.parent.log.error("Socket: Error from socket server."),this._connect_attempts++,this.reconnect()},this.socket.onclose=()=>{this._connected&&this.socket&&(this.parent.log.info("Socket: Lost connection to socket server..."),this._connect_attempts++,this.reconnect())},this.socket.onmessage=t=>{let e;try{e=JSON.parse(t.data)}catch(t){this.parent.log.error("Socket: Error parsing message",t)}e&&this._events[e.name]&&(this.parent.log.debug("Socket: Received event",e),this._events[e.name](e.data))}))}reconnect(){this.disconnect(),!1!==this._connecting&&(this._connecting=!1,this.parent.log.info("Socket: Trying to reconnect to socket server..."),setTimeout(()=>{this.reconnecting=!0,this.connect()},Math.random()*(Math.pow(2,this._connect_attempts)-1)*1e4))}disconnect(){if(this.socket)try{this.socket.close()}catch(t){}delete this.socket,this._connected=!1,this._connecting=!1}disconnectInternal(){this.disconnect(),this.parent.log.info("Socket: Disconnected from socket server.")}emit(t,e){this._connected&&this.socket&&this.socket.send(JSON.stringify({name:t,data:e}))}broadcastMe(t){this._connected&&this.parent.site.getUser()&&this.emit("broadcast_me",{name:this.parent.site.getUser().login,channel:t})}joinChannel(t){this._connected?t&&t.length&&(this._joined_channels[t]&&this.partChannel(t),this.emit("join_channel",{name:t}),this._joined_channels[t]=!0,this.broadcastMe(t)):this._connection_buffer.includes(t)||this._connection_buffer.push(t)}partChannel(t){this._connected&&t.length&&(this._joined_channels[t]&&this.emit("part_channel",{name:t}),delete this._joined_channels[t])}}class ProUser{constructor(t,e,s,o){this.parent=t,this.userID=e,this.badge=s,this.setID="addon--ffzap.betterttv--emotes-pro-"+this.userID,this.emotes=o||[],this.loadBadge(s,!0),this.loadEmotes(o,!0)}isBadgeEqual(t=null){var e,s;return(null===(e=this.badge)||void 0===e?void 0:e.url)==(null==t?void 0:t.url)&&(null===(s=this.badge)||void 0===s?void 0:s.startedAt)==(null==t?void 0:t.startedAt)}areEmotesEqual(t=[]){return this.emotes.length===t.length&&t.every(t=>this.emotes.includes(t.id))}loadBadge(t=null,e=!1){if(window.BetterTTV)return!1;if(!e&&this.isBadgeEqual(t))return!1;if(this.badge=t,t){const e={image:t.url,title:`BetterTTV Pro\n(Since ${this.parent.i18n.formatDate(new Date(t.startedAt))})`};this.parent.chat.getUser(this.userID).addBadge("addon--ffzap.betterttv",this.parent.getProBadgeID(),e)}else this.parent.chat.getUser(this.userID).removeBadge("addon--ffzap.betterttv",this.parent.getProBadgeID());return!0}loadEmotes(t=[],e=!1){if(!e&&this.areEmotesEqual(t))return!1;this.emotes=t.map(t=>t.id);const s=[];for(let e=0;e<t.length;e++)s.push(this.parent.convertBTTVEmote(t[e]));const o={emotes:s,title:"Personal Emotes",source:"BetterTTV",icon:"https://betterttv.com/favicon.png"};return s.length?(this.parent.emotes.loadSetData(this.setID,o,!0),this.parent.chat.getUser(this.userID).addSet("addon--ffzap.betterttv",this.setID)):this.unload(),!0}unload(){this.parent.emotes.unloadSet(this.setID,!0)}}const o=["channel"];class ffzap_bttv_BetterTTV extends FrankerFaceZ.utilities.addon.Addon{constructor(...t){super(...t),this.inject("settings"),this.inject("chat"),this.inject("chat.emotes"),this.inject("chat.badges"),this.inject("site"),this.inject("i18n"),this.settings.add("ffzap.betterttv.global_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes",title:"Global Emotes",description:"Enable to show global BetterTTV emoticons.",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.arbitrary_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes",title:"Arbitrary Emotes",description:"Enable to show arbitrary emoticons (like D:, :tf: and similar).",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.channel_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes",title:"Channel Emotes",description:"Enable to show per-channel BetterTTV emoticons.",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.pro_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes",title:"Pro Emotes",description:"Enable to show BetterTTV Pro emoticons.",component:"setting-check-box"}}),this.chat.context.on("changed:ffzap.betterttv.global_emoticons",this.updateEmotes,this),this.chat.context.on("changed:ffzap.betterttv.arbitrary_emoticons",this.updateEmotes,this),this.chat.context.on("changed:ffzap.betterttv.channel_emoticons",this.updateEmotes,this),this.chat.context.on("changed:ffzap.betterttv.pro_emoticons",()=>{if(this.chat.context.get("ffzap.betterttv.pro_emoticons")){this.socket.connect();for(const t of this.chat.iterateRooms())t&&this.updateChannel(t)}else{for(const t in this.ProUsers)({}).hasOwnProperty.call(this.ProUsers,t)&&this.ProUsers[t].unload();this.ProUsers={},this.socket.disconnectInternal()}},this),this.pro_users={},this.night_subs={},this.socket=!1,this.room_emotes={}}onEnable(){this.log.debug("FFZ:AP's BetterTTV Emotes module was enabled successfully."),this.on("chat:room-add",this.roomAdd),this.on("chat:room-remove",this.roomRemove),this.on("chat:receive-message",this.onReceiveMessage),this.addBadges(),this.socket=new Socket(this,this.getSocketEvents()),this.updateGlobalEmotes(),this.chat.context.get("ffzap.betterttv.pro_emoticons")&&this.socket.connect();for(const t of this.chat.iterateRooms())t&&this.updateChannel(t);this.addProBadge()}roomAdd(t){this.updateChannel(t)}roomRemove(t){this.updateChannel(t),this.chat.context.get("ffzap.betterttv.pro_emoticons")&&this.socket.partChannel(t.id)}onReceiveMessage(t){const e=this.resolve("site").getUser();if(e){const s=t.message.user.id;e.id===s&&this.socket.broadcastMe("twitch:"+t.channelID)}}getSocketEvents(){return{lookup_user:t=>{let e=!1,s=!1;if(t.subscribed&&(this.night_subs[t.providerId]||(this.night_subs[t.providerId]=!0,this.chat.getUser(t.providerId).addSet("addon--ffzap.betterttv","addon--ffzap.betterttv--emotes-special-night"),e=!0)),t.pro){let o=this.pro_users[t.providerId];o||(o=this.pro_users[t.providerId]=new ProUser(this,t.providerId,t.badge,t.emotes),e=!0,s=!0),this.chat.context.get("ffzap.betterttv.pro_emoticons")&&o.loadEmotes(t.emotes)&&(e=!0),o.loadBadge(t.badge)&&(s=!0)}(e||s)&&this.emit("chat:update-lines-by-user",t.providerId,t.name,e,s)},emote_create:({channel:t,emote:e})=>{const s=this.room_emotes[t];if(!s)return;if(s.some(t=>t.id===e.id))return;const o=this.convertBTTVEmote(e);s.push(o),this.emotes.addEmoteToSet(this.getChannelSetID(t,!1),o)},emote_delete:({channel:t,emoteId:e})=>{const s=this.room_emotes[t];s&&(this.room_emotes[t]=s.filter(t=>t.id!==e),this.emotes.removeEmoteFromSet(this.getChannelSetID(t,!1),e))},emote_update:t=>{let{channel:e}=t;const s=function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};var s,o,n={},i=Object.keys(t);for(o=0;o<i.length;o++)s=i[o],e.indexOf(s)>=0||(n[s]=t[s]);return n}(t,o).emote,n=this.room_emotes[e];if(!n)return;const i=n.find(t=>t.id===s.id);i&&(i.name=s.code,this.emotes.addEmoteToSet(this.getChannelSetID(e,!1),i))}}}getProBadgeID(){return"addon--ffzap.betterttv--badges-bttv-pro"}addProBadge(){if(window.BetterTTV)return;const t={id:"bttv-pro",slot:21,title:"BetterTTV Pro",no_invert:!0,image:"https://cdn.betterttv.net/badges/pro/0b58eba8-e49c-4ed7-ae7d-be0b524502e6.png"};this.badges.loadBadgeData(this.getProBadgeID(),t)}async addBadges(t=0){if(window.BetterTTV)return void this.log.info("Not adding BTTV badges because BTTV is present.");const e=await fetch("https://api.betterttv.net/3/cached/badges");if(e.ok){const t=await e.json(),s=[],o=new RegExp(/\/badges\/(\w+)\.svg/);let n=t.length;for(;n--;){const e=t[n];if(!o.test(e.badge.svg))continue;const i=o.exec(e.badge.svg)[1];if(!s[i]){const t={id:"bttv-"+i,slot:21,image:e.badge.svg,svg:!0,title:e.badge.description,no_invert:!0};s[i]=!0,this.badges.loadBadgeData("addon--ffzap.betterttv--badges-bttv-"+i,t)}this.chat.getUser(e.providerId).addBadge("addon--ffzap.betterttv","addon--ffzap.betterttv--badges-bttv-"+i)}}else{if(404===e.status)return;const s=(t||0)+1;s<12&&(this.log.error("Failed to fetch badges. Trying again in 5 seconds."),setTimeout(this.addBadges.bind(this,s),5e3))}}async updateGlobalEmotes(t=0){const e="addon--ffzap.betterttv--emotes-global";if(this.emotes.removeDefaultSet("addon--ffzap.betterttv",e),this.emotes.unloadSet(e),!this.chat.context.get("ffzap.betterttv.global_emoticons"))return;const s=await fetch("https://api.betterttv.net/3/cached/emotes/global");if(s.ok){const t=await s.json(),o=[],n=[],i=[],r={cvMask:"3px 0 0 0",cvHazmat:"3px 0 0 0",SoSnowy:"2px 0 0 0",IceCold:"2px 0 0 0",TopHat:null,SantaHat:null,ReinDeer:null,CandyCane:null};let a,c=t.length;for(;c--;){const e=this.convertBTTVEmote(t[c]);e.modifier=Object.prototype.hasOwnProperty.call(r,e.name),e.modifier_offset=r[e.name];const s=/[^A-Za-z0-9]/.test(e.name);e.channel&&"night"===e.channel?i.push(e):s?n.push(e):o.push(e)}i.length>0&&(a={emotes:i,title:"Night (Legacy)",source:"BetterTTV",icon:"https://betterttv.com/favicon.png",sort:50},this.emotes.loadSetData("addon--ffzap.betterttv--emotes-special-night",a));let h=[];if(h=h.concat(o),this.chat.context.get("ffzap.betterttv.arbitrary_emoticons")&&(h=h.concat(n)),0===h.length)return;a={emotes:h,title:"Global Emotes",source:"BetterTTV",icon:"https://betterttv.com/favicon.png",_type:1},this.emotes.addDefaultSet("addon--ffzap.betterttv",e,a)}else{if(404===s.status)return;const e=(t||0)+1;e<12&&(this.log.error("Failed to fetch global emotes. Trying again in 5 seconds."),setTimeout(this.updateGlobalEmotes.bind(this,e),5e3))}}getChannelSetID(t,e=!0){return"addon--ffzap.betterttv--channel-"+(e?this.getBTTVRoomID(t):t)}getBTTVRoomID(t){return"twitch:"+t}convertBTTVEmote({id:t,code:e,user:s,animated:o}){const n=/[^A-Za-z0-9]/.test(e),i={urls:{1:`https://cdn.betterttv.net/emote/${t}/1x.webp`,2:`https://cdn.betterttv.net/emote/${t}/2x.webp`,4:`https://cdn.betterttv.net/emote/${t}/3x.webp`},id:t,name:e,width:28,height:28,owner:{display_name:s&&s.displayName,name:s&&s.name},require_spaces:n,click_url:"https://betterttv.com/emotes/"+t};return o&&(i.animated=i.urls,i.urls={1:`https://cdn.betterttv.net/emote/${t}/static/1x.webp`,2:`https://cdn.betterttv.net/emote/${t}/static/2x.webp`,4:`https://cdn.betterttv.net/emote/${t}/static/3x.webp`}),i}async updateChannel(t,e=0){const s=this.getChannelSetID(t.id);t.removeSet("addon--ffzap.betterttv",s);const o=this.getBTTVRoomID(t.id);if(this.chat.context.get("ffzap.betterttv.pro_emoticons")&&this.socket.joinChannel(o),!this.chat.context.get("ffzap.betterttv.channel_emoticons"))return;const n=await fetch("https://api.betterttv.net/3/cached/users/twitch/"+t.id);if(n.ok){const e=this.room_emotes[o]=[],{channelEmotes:i,sharedEmotes:r,bots:a}=await n.json(),c=i.concat(r);for(const e of a){const s=t.getUser(null,e);s&&s.addBadge("ffz",2)}let h=c.length;for(;h--;)e.push(this.convertBTTVEmote(c[h]));if(!e.length)return;const d={emotes:e,title:"Channel Emotes",source:"BetterTTV",icon:"https://betterttv.com/favicon.png",_type:1};e.length?(this.emotes.loadSetData(s,d,!1),t.addSet("addon--ffzap.betterttv",s)):t.removeSet("addon--ffzap.betterttv",s)}else{if(404===n.status)return;const s=(e||0)+1;s<12&&(this.log.error("Failed to fetch channel emotes. Trying again in 5 seconds."),setTimeout(this.updateChannel.bind(this,t,s),5e3))}}updateEmotes(){this.updateGlobalEmotes();for(const t of this.chat.iterateRooms())t&&this.updateChannel(t)}}ffzap_bttv_BetterTTV.register("ffzap-bttv")}});
//# sourceMappingURL=script.aa32e2b26e42c0045038.js.map